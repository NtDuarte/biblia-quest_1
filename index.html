<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BibliaQuest - Duarte & Maria Clara</title>
    <style>
        :root { --primary: #58cc02; --blue: #1cb0f6; --bg: #f7f7f7; --text: #4b4b4b; }
        body { font-family: sans-serif; background: var(--bg); margin: 0; display: flex; justify-content: center; color: var(--text); }
        #app { width: 100%; max-width: 500px; background: white; min-height: 100vh; padding: 20px; box-sizing: border-box; box-shadow: 0 0 10px rgba(0,0,0,0.05); }
        .hidden { display: none; }
        input { width: 100%; padding: 12px; margin: 10px 0; border: 2px solid #e5e5e5; border-radius: 12px; box-sizing: border-box; }
        button { width: 100%; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .card { border: 2px solid #e5e5e5; border-radius: 15px; padding: 15px; margin: 20px 0; background: white; }
        .header-stats { display: flex; justify-content: space-between; align-items: center; font-weight: bold; padding-bottom: 15px; border-bottom: 2px solid #f1f1f1; }
        #verse-text { font-style: italic; font-size: 1.1rem; line-height: 1.5; margin: 10px 0; }
        #ai-study-content { white-space: pre-wrap; line-height: 1.6; font-size: 0.95rem; }
    </style>
</head>
<body>

<div id="app">
    <div id="auth-screen">
        <h2 style="color:var(--primary); text-align:center">BibliaQuest</h2>
        <input type="email" id="login-email" placeholder="E-mail">
        <input type="password" id="login-pass" placeholder="Senha">
        <button onclick="handleAuth('login')">Entrar</button>
        <button style="background: var(--blue)" onclick="handleAuth('signup')">Criar Conta</button>
    </div>

    <div id="main-screen" class="hidden">
        <div class="header-stats">
            <span id="user-display">UsuÃ¡rio</span>
            <span>ðŸ”¥ <b id="streak-val">0</b> | XP: <b id="xp-val">0</b></span>
        </div>
        
        <div class="card">
            <h3>ðŸ“– Palavra do Dia</h3>
            <p id="verse-text">Carregando mensagem especial...</p>
            <small id="verse-ref" style="color: var(--blue); font-weight:bold"></small>
        </div>

        <button id="btn-study" onclick="generateStudy()">Gerar Estudo com IA</button>

        <div id="study-area" class="hidden">
            <div class="card" id="ai-study-content" style="background: #f0f9ff; border-color: var(--blue);"></div>
        </div>
        
        <button style="background: #ff4b4b; margin-top: 20px; padding: 8px;" onclick="location.reload()">Sair / Recarregar</button>
    </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  // CONFIGURAÃ‡ÃƒO FIREBASE
  const firebaseConfig = {
    apiKey: "AIzaSyCAqU2eK-r5BBSud1nSZJHSbykATXdQNS4",
    authDomain: "bibliaquest-fbc44.firebaseapp.com",
    projectId: "bibliaquest-fbc44",
    storageBucket: "bibliaquest-fbc44.firebasestorage.app",
    messagingSenderId: "670585434397",
    appId: "1:670585434397:web:6d699582986e8dcbc6f1f4"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // PROTEÃ‡ÃƒO CONTRA BLOQUEIO DO GITHUB
  let GROQ_API_KEY = localStorage.getItem("groq_key");

  // LÃ“GICA DE LOGIN
  window.handleAuth = async (type) => {
    const email = document.getElementById('login-email').value;
    const pass = document.getElementById('login-pass').value;
    try {
        if (type === 'signup') {
            const res = await createUserWithEmailAndPassword(auth, email, pass);
            await setDoc(doc(db, "users", res.user.uid), { xp: 0, streak: 1, name: email.split('@')[0] });
        } else {
            await signInWithEmailAndPassword(auth, email, pass);
        }
    } catch (e) { alert("Erro: " + e.message); }
  };

  onAuthStateChanged(auth, async (user) => {
    if (user) {
        document.getElementById('auth-screen').classList.add('hidden');
        document.getElementById('main-screen').classList.remove('hidden');
        document.getElementById('user-display').innerText = user.email.split('@')[0];
        
        // Se nÃ£o tiver a chave salva, pede agora
        if (!GROQ_API_KEY) {
            GROQ_API_KEY = prompt("Insira sua NOVA chave do Groq (Isso evita bloqueio do GitHub):");
            if (GROQ_API_KEY) localStorage.setItem("groq_key", GROQ_API_KEY);
        }

        loadUserData(user.uid);
        fetchVerse();
    }
  });

  async function loadUserData(uid) {
    const snap = await getDoc(doc(db, "users", uid));
    if (snap.exists()) {
        document.getElementById('xp-val').innerText = snap.data().xp;
        document.getElementById('streak-val').innerText = snap.data().streak;
    }
  }

  // BUSCA VERSÃCULO (MÃ‰TODO MAIS ESTÃVEL)
  async function fetchVerse() {
    try {
        // Buscamos JoÃ£o 3:16 como teste inicial para garantir que a conexÃ£o funciona
        const res = await fetch('https://bible-api.com/john+3:16?translation=almeida');
        const data = await res.json();
        document.getElementById('verse-text').innerText = `"${data.text.trim()}"`;
        document.getElementById('verse-ref').innerText = data.reference;
        window.currentVerse = data.text;
    } catch (e) {
        document.getElementById('verse-text').innerText = "Erro ao buscar a Palavra. Verifique sua internet.";
    }
  }

  // IA COM GROQ
  window.generateStudy = async () => {
    const btn = document.getElementById('btn-study');
    const studyContent = document.getElementById('ai-study-content');
    
    if (!GROQ_API_KEY) return alert("Por favor, recarregue e insira uma chave vÃ¡lida.");

    btn.innerText = "Pensando...";
    btn.disabled = true;

    try {
        const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
            method: "POST",
            headers: {
                "Authorization": `Bearer ${GROQ_API_KEY}`,
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                model: "llama-3.3-70b-versatile",
                messages: [{ role: "system", content: "VocÃª Ã© um tutor bÃ­blico. Responda em PortuguÃªs." },
                           { role: "user", content: `FaÃ§a um devocional para: ${window.currentVerse}` }]
            })
        });

        const data = await response.json();
        if (data.choices) {
            document.getElementById('study-area').classList.remove('hidden');
            studyContent.innerText = data.choices[0].message.content;
            btn.innerText = "ConcluÃ­do!";
        } else {
            alert("Sua chave do Groq parece invÃ¡lida ou foi bloqueada.");
            localStorage.removeItem("groq_key");
        }
    } catch (e) {
        alert("Erro na IA. Tente novamente.");
        btn.disabled = false;
    }
  };
</script>
</body>
</html>

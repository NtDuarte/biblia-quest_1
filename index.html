<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BibliaQuest - Estudo Di√°rio</title>
    <style>
        :root { --primary: #58cc02; --blue: #1cb0f6; --bg: #f7f7f7; }
        body { font-family: sans-serif; background: var(--bg); margin: 0; display: flex; justify-content: center; }
        #app { width: 100%; max-width: 500px; background: white; min-height: 100vh; padding: 20px; box-sizing: border-box; }
        .hidden { display: none; }
        input { width: 100%; padding: 12px; margin: 10px 0; border: 2px solid #e5e5e5; border-radius: 12px; }
        button { width: 100%; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .card { border: 2px solid #e5e5e5; border-radius: 15px; padding: 15px; margin: 20px 0; }
        .progress-bar { height: 10px; background: #e5e5e5; border-radius: 5px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--primary); width: 0%; transition: 0.3s; }
    </style>
</head>
<body>

<div id="app">
    <div id="auth-screen">
        <h2>BibliaQuest</h2>
        <p>Aprenda a Palavra todo dia.</p>
        <input type="email" id="login-email" placeholder="E-mail">
        <input type="password" id="login-pass" placeholder="Senha">
        <button onclick="handleAuth('login')">Entrar</button>
        <button style="background: var(--blue)" onclick="handleAuth('signup')">Criar Conta</button>
    </div>

    <div id="main-screen" class="hidden">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <span id="user-display">Duarte</span>
            <span>üî• <b id="streak-val">0</b> | XP: <b id="xp-val">0</b></span>
        </div>
        
        <div class="card">
            <h3>üìñ Palavra do Dia</h3>
            <p id="verse-text">Buscando vers√≠culo...</p>
            <small id="verse-ref"></small>
        </div>

        <button id="btn-study" onclick="generateStudy()">Gerar Estudo com IA</button>

        <div id="study-area" class="hidden">
            <div class="card" id="ai-study-content" style="background: #f0f9ff;">
                </div>
            <div id="quiz-area"></div>
        </div>
    </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  // 1. CONFIGURA√á√ÉO (COLE AS SUAS CHAVES AQUI)
  const firebaseConfig = {
    apiKey: "AIzaSyCAqU2eK-r5BBSud1nSZJHSbykATXdQNS4",
    authDomain: "bibliaquest-fbc44.firebaseapp.com",
    projectId: "bibliaquest-fbc44",
    storageBucket: "bibliaquest-fbc44.firebasestorage.app",
    messagingSenderId: "670585434397",
    appId: "1:670585434397:web:6d699582986e8dcbc6f1f4",
    measurementId: "G-H0Z7T8LCPE"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const GEMINI_API_KEY = "AIzaSyDz9q3SsfdD4BO91sETPTbqd21ijXIw8xo";

  // 2. L√ìGICA DE AUTENTICA√á√ÉO
  window.handleAuth = async (type) => {
    const email = document.getElementById('login-email').value;
    const pass = document.getElementById('login-pass').value;
    try {
        if (type === 'signup') {
            const res = await createUserWithEmailAndPassword(auth, email, pass);
            await setDoc(doc(db, "users", res.user.uid), { xp: 0, streak: 1, name: email.split('@')[0] });
        } else {
            await signInWithEmailAndPassword(auth, email, pass);
        }
    } catch (e) { alert("Erro: " + e.message); }
  };

  // 3. MONITORAR USU√ÅRIO
  onAuthStateChanged(auth, async (user) => {
    if (user) {
        document.getElementById('auth-screen').classList.add('hidden');
        document.getElementById('main-screen').classList.remove('hidden');
        loadUserData(user.uid);
        fetchVerse();
    }
  });

  async function loadUserData(uid) {
    const snap = await getDoc(doc(db, "users", uid));
    if (snap.exists()) {
        document.getElementById('xp-val').innerText = snap.data().xp;
        document.getElementById('streak-val').innerText = snap.data().streak;
    }
  }

  // 4. API DA B√çBLIA (LABS BIBLE - MAIS EST√ÅVEL PARA RANDOM)
  async function fetchVerse() {
    try {
        // Esta API retorna um vers√≠culo aleat√≥rio em formato JSON
        const res = await fetch('https://labs.bible.org/api/?passage=random&type=json');
        const data = await res.json();
        
        const text = data[0].text;
        const ref = `${data[0].bookname} ${data[0].chapter}:${data[0].verse}`;
        
        document.getElementById('verse-text').innerText = `"${text.trim()}"`;
        document.getElementById('verse-ref').innerText = ref;
        window.currentVerse = text; 
    } catch (e) {
        console.error("Erro na B√≠blia:", e);
        document.getElementById('verse-text').innerText = "Erro ao buscar vers√≠culo. Tente recarregar.";
    }
  }

  // 5. INTEGRA√á√ÉO COM GEMINI (AJUSTADA)
  window.generateStudy = async () => {
    const btn = document.getElementById('btn-study');
    const studyArea = document.getElementById('ai-study-content');
    
    btn.innerText = "IA pensando...";
    btn.disabled = true;

    const prompt = `Aja como um tutor b√≠blico. Com base no vers√≠culo "${window.currentVerse}", escreva um breve devocional (m√°ximo 400 caracteres). Depois, crie uma pergunta de m√∫ltipla escolha com 3 op√ß√µes (A, B, C) sobre o texto.`;

    try {
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                contents: [{ parts: [{ text: prompt }] }]
            })
        });

        const data = await response.json();
        
        // Verifica se a IA retornou o texto corretamente
        if (data.candidates && data.candidates[0].content) {
            const textoIA = data.candidates[0].content.parts[0].text;
            document.getElementById('study-area').classList.remove('hidden');
            studyArea.innerText = textoIA;
            btn.innerText = "Estudo Conclu√≠do";
        } else {
            throw new Error("Resposta da IA vazia ou erro na chave.");
        }
    } catch (e) { 
        console.error("Erro Gemini:", e);
        alert("Erro na IA: Verifique se sua API KEY est√° correta e ativa.");
        btn.innerText = "Tentar Novamente";
        btn.disabled = false;
    }
  };
</script>

</body>
</html>

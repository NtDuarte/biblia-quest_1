<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BibliaQuest | Duarte</title>

<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&display=swap" rel="stylesheet">

<style>
:root {
  --primary:#58cc02;
  --blue:#1cb0f6;
  --text:#3c3c3c;
}

body {
  margin:0;
  background:#f7f7f7;
  display:flex;
  justify-content:center;
  font-family:'Nunito',sans-serif;
}

#app {
  width:100%;
  max-width:480px;
  min-height:100vh;
  background:white;
  padding:20px;
  box-sizing:border-box;
}

.hidden { display:none; }

.card {
  border:2px solid #e5e5e5;
  border-bottom:6px solid #e5e5e5;
  border-radius:20px;
  padding:18px;
  margin:15px 0;
}

.btn {
  width:100%;
  padding:16px;
  border:none;
  border-radius:16px;
  font-weight:900;
  text-transform:uppercase;
  background:var(--primary);
  color:white;
  cursor:pointer;
  margin-top:10px;
}

.btn.blue {
  background:var(--blue);
}

input {
  width:100%;
  padding:14px;
  margin:10px 0;
  border-radius:14px;
  border:2px solid #e5e5e5;
  background:#f7f7f7;
}

.nav {
  position:fixed;
  bottom:0;
  width:100%;
  max-width:480px;
  display:flex;
  justify-content:space-around;
  background:white;
  border-top:2px solid #e5e5e5;
  padding:12px;
}

.nav span {
  font-weight:900;
  cursor:pointer;
  color:#aaa;
}

.nav .active {
  color:var(--blue);
}

#ai-response {
  white-space:pre-wrap;
}
</style>
</head>

<body>
<div id="app">

<!-- LOGIN -->
<div id="auth">
  <h1 style="text-align:center;color:var(--primary)">BibliaQuest</h1>
  <input id="email" placeholder="E-mail">
  <input id="pass" type="password" placeholder="Senha">
  <button class="btn" onclick="authUser('login')">Entrar</button>
  <button class="btn blue" onclick="authUser('signup')">Criar conta</button>
</div>

<!-- APP -->
<div id="main" class="hidden">

<div class="card">
  <b id="userName"></b><br>
  NÃ­vel <b id="level">1</b> â€¢ ğŸ”¥ <span id="streak">0</span> â€¢ ğŸ’ <span id="xp">0</span>
</div>

<div class="card">
  <h3>ğŸ“– Palavra do Dia</h3>
  <p id="verse">Carregando...</p>
  <small id="ref"></small>
</div>

<button class="btn" onclick="generateStudy()">Gerar Estudo</button>

<div id="study" class="hidden">
  <div class="card" id="ai-response"></div>
  <button class="btn blue" onclick="finishStudy()">Concluir (+10 XP)</button>
</div>

<div id="ranking" class="hidden">
  <h3>ğŸ† Ranking</h3>
  <div class="card" id="rankList"></div>
</div>

</div>

<div class="nav hidden" id="nav">
  <span class="active" onclick="showTab('study')">Estudo</span>
  <span onclick="showTab('rank')">Ranking</span>
  <span style="color:#ff4b4b" onclick="logout()">Sair</span>
</div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, updateDoc, increment, collection, getDocs, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey:"AIzaSyCAqU2eK-r5BBSud1nSZJHSbykATXdQNS4",
  authDomain:"bibliaquest-fbc44.firebaseapp.com",
  projectId:"bibliaquest-fbc44"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

window.authUser = async (type) => {
  try {
    if(type==="signup"){
      const r = await createUserWithEmailAndPassword(auth,email.value,pass.value);
      await setDoc(doc(db,"users",r.user.uid),{xp:0,streak:1,name:email.value.split("@")[0]});
    } else {
      await signInWithEmailAndPassword(auth,email.value,pass.value);
    }
  } catch(e){ alert(e.message); }
};

window.logout = () => signOut(auth);

onAuthStateChanged(auth, async (u)=>{
  auth.classList.toggle("hidden",!!u);
  main.classList.toggle("hidden",!u);
  nav.classList.toggle("hidden",!u);
  if(u){
    userName.innerText = u.email.split("@")[0];
    loadUser();
    fetchVerse();
  }
});

async function loadUser(){
  const s = await getDoc(doc(db,"users",auth.currentUser.uid));
  if(s.exists()){
    xp.innerText = s.data().xp;
    streak.innerText = s.data().streak;
    level.innerText = Math.floor(s.data().xp/100)+1;
  }
}

async function fetchVerse(){
  try{
    const r = await fetch("https://bible-api.com/random?translation=almeida");
    const d = await r.json();
    verse.innerText = d.text;
    ref.innerText = d.reference;
    window.currentVerse = d.text;
  }catch{
    verse.innerText = "O Senhor Ã© o meu pastor; nada me faltarÃ¡.";
    ref.innerText = "Salmos 23:1";
    window.currentVerse = verse.innerText;
  }
}

window.generateStudy = () => {
  study.classList.remove("hidden");
  ai-response.innerText = `
ğŸ“– Estudo Guiado

VersÃ­culo:
"${window.currentVerse}"

ReflexÃ£o:
Este texto nos chama Ã  confianÃ§a, Ã  obediÃªncia e Ã  fÃ© prÃ¡tica no dia a dia.

Pergunta:
O que essa Palavra estÃ¡ te convidando a mudar hoje?
`;
};

window.finishStudy = async () => {
  await updateDoc(doc(db,"users",auth.currentUser.uid),{xp:increment(10)});
  alert("ParabÃ©ns! +10 XP");
  location.reload();
};

window.showTab = async (t) => {
  study.classList.toggle("hidden",t!=="study");
  ranking.classList.toggle("hidden",t!=="rank");
  if(t==="rank"){
    const q = query(collection(db,"users"),orderBy("xp","desc"),limit(5));
    const s = await getDocs(q);
    rankList.innerHTML="";
    s.forEach((d,i)=>{
      rankList.innerHTML+=`<div>${i+1}Âº ${d.data().name} â€” ${d.data().xp} XP</div>`;
    });
  }
};
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BibliaQuest | Duarte</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root { 
            --primary: #58cc02; 
            --primary-dark: #46a302;
            --blue: #1cb0f6; 
            --bg: #ffffff; 
            --text: #3c3c3c;
            --card-bg: #ffffff;
        }
        
        body { 
            font-family: 'Nunito', sans-serif; 
            background-color: #f7f7f7; 
            margin: 0; 
            display: flex; 
            justify-content: center; 
            color: var(--text); 
        }

        #app { 
            width: 100%; 
            max-width: 480px; 
            background: var(--bg); 
            min-height: 100vh; 
            padding: 25px; 
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
        }

        .hidden { display: none !important; }

        /* Estilo dos Cards */
        .card { 
            border: 2px solid #e5e5e5; 
            border-bottom: 5px solid #e5e5e5;
            border-radius: 18px; 
            padding: 20px; 
            margin: 15px 0; 
            background: var(--card-bg);
            transition: transform 0.1s;
        }

        /* Stats Bar */
        .header-stats { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 10px 0;
            border-bottom: 2px solid #e5e5e5;
            margin-bottom: 10px;
        }

        .stat-item { display: flex; align-items: center; gap: 5px; font-weight: 900; color: #afafaf; }
        .stat-item b { color: #ff9600; } /* Cor do Fogo */
        .stat-xp b { color: #1cb0f6; } /* Cor do XP */

        /* Bot√£o Estilo Duolingo */
        .btn-duo {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 15px;
            font-size: 17px;
            font-weight: 900;
            text-transform: uppercase;
            cursor: pointer;
            transition: filter 0.2s, transform 0.1s;
            background: var(--primary);
            color: white;
            border-bottom: 5px solid var(--primary-dark);
            margin-top: 15px;
        }

        .btn-duo:active { transform: translateY(4px); border-bottom: 0; }
        .btn-duo:disabled { background: #e5e5e5; border-bottom: 5px solid #afafaf; color: #afafaf; cursor: not-allowed; }

        .btn-blue { background: var(--blue); border-bottom: 5px solid #1899d6; }

        /* Estudo da IA */
        #ai-study-content { 
            line-height: 1.6; 
            font-size: 1rem; 
            color: #4b4b4b;
            white-space: pre-wrap;
        }

        h1, h2, h3 { font-weight: 900; margin-top: 0; }
        input { 
            width: 100%; padding: 15px; margin: 10px 0; 
            border: 2px solid #e5e5e5; border-radius: 15px; 
            background: #f7f7f7; font-size: 16px; box-sizing: border-box;
        }
    </style>
</head>
<body>

<div id="app">
    <div id="auth-screen">
        <h2 style="text-align:center; font-size: 2rem; color: var(--primary);">BibliaQuest</h2>
        <p style="text-align:center; font-weight: 700; color: #afafaf;">Aprenda a Palavra com Duarte</p>
        <input type="email" id="login-email" placeholder="E-MAIL">
        <input type="password" id="login-pass" placeholder="SENHA">
        <button class="btn-duo" onclick="handleAuth('login')">ENTRAR</button>
        <button class="btn-duo btn-blue" onclick="handleAuth('signup')">CRIAR CONTA</button>
    </div>

    <div id="main-screen" class="hidden">
        <div class="header-stats">
            <span id="user-display" style="font-weight: 900; color: var(--primary);">USU√ÅRIO</span>
            <div style="display: flex; gap: 15px;">
                <div class="stat-item">üî• <b id="streak-val">0</b></div>
                <div class="stat-item stat-xp">üíé <b id="xp-val">0</b></div>
            </div>
        </div>
        
        <div class="card">
            <h3 style="color: var(--blue); font-size: 1.2rem;">üìñ PALAVRA DO DIA</h3>
            <p id="verse-text" style="font-weight: 700; font-size: 1.1rem;"></p>
            <div id="verse-ref" style="color: #afafaf; font-weight: 900; font-size: 0.9rem;"></div>
        </div>

        <button id="btn-study" class="btn-duo" onclick="generateStudy()">GERAR ESTUDO COM IA</button>

        <div id="study-area" class="hidden">
            <div class="card" style="border-color: var(--blue); background: #f0fbff;">
                <div id="ai-study-content"></div>
            </div>
            <button id="btn-finish" class="btn-duo btn-blue" onclick="finishTask()">CONCLUIR TAREFA (+10 XP)</button>
        </div>

        <button style="background:none; border:none; color:#afafaf; font-weight:900; cursor:pointer; margin-top: auto; padding: 20px;" onclick="logout()">SAIR DA CONTA</button>
    </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import { getFirestore, doc, setDoc, getDoc, updateDoc, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCAqU2eK-r5BBSud1nSZJHSbykATXdQNS4",
    authDomain: "bibliaquest-fbc44.firebaseapp.com",
    projectId: "bibliaquest-fbc44",
    storageBucket: "bibliaquest-fbc44.firebasestorage.app",
    messagingSenderId: "670585434397",
    appId: "1:670585434397:web:6d699582986e8dcbc6f1f4"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  let GROQ_API_KEY = localStorage.getItem("groq_key");

  // --- AUTENTICA√á√ÉO ---
  window.handleAuth = async (type) => {
    const email = document.getElementById('login-email').value;
    const pass = document.getElementById('login-pass').value;
    try {
        if (type === 'signup') {
            const res = await createUserWithEmailAndPassword(auth, email, pass);
            await setDoc(doc(db, "users", res.user.uid), { xp: 0, streak: 1, name: email.split('@')[0] });
        } else {
            await signInWithEmailAndPassword(auth, email, pass);
        }
    } catch (e) { alert("Erro: " + e.message); }
  };

  window.logout = () => signOut(auth);

  onAuthStateChanged(auth, async (user) => {
    if (user) {
        document.getElementById('auth-screen').classList.add('hidden');
        document.getElementById('main-screen').classList.remove('hidden');
        document.getElementById('user-display').innerText = user.email.split('@')[0].toUpperCase();
        
        if (!GROQ_API_KEY) {
            GROQ_API_KEY = prompt("Insira sua chave do Groq para come√ßar:");
            if (GROQ_API_KEY) localStorage.setItem("groq_key", GROQ_API_KEY);
        }
        loadUserData(user.uid);
        fetchVerse();
    } else {
        document.getElementById('auth-screen').classList.remove('hidden');
        document.getElementById('main-screen').classList.add('hidden');
    }
  });

  async function loadUserData(uid) {
    const snap = await getDoc(doc(db, "users", uid));
    if (snap.exists()) {
        document.getElementById('xp-val').innerText = snap.data().xp;
        document.getElementById('streak-val').innerText = snap.data().streak;
    }
  }

  // --- B√çBLIA ---
  async function fetchVerse() {
    const textEl = document.getElementById('verse-text');
    textEl.innerText = "Buscando luz...";
    try {
        const res = await fetch('https://bible-api.com/random?translation=almeida');
        const data = await res.json();
        textEl.innerText = `"${data.text.trim()}"`;
        document.getElementById('verse-ref').innerText = data.reference.toUpperCase();
        window.currentVerse = data.text;
    } catch (e) { textEl.innerText = "Erro ao carregar vers√≠culo."; }
  }

  // --- IA E XP ---
  window.generateStudy = async () => {
    const btn = document.getElementById('btn-study');
    const studyArea = document.getElementById('study-area');
    const content = document.getElementById('ai-study-content');
    
    btn.innerText = "IA PENSANDO...";
    btn.disabled = true;

    try {
        const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
            method: "POST",
            headers: { "Authorization": `Bearer ${GROQ_API_KEY}`, "Content-Type": "application/json" },
            body: JSON.stringify({
                model: "llama-3.3-70b-versatile",
                messages: [{ role: "system", content: "Tutor b√≠blico PT-BR. Gere um t√≠tulo, devocional curto e uma pergunta." },
                           { role: "user", content: `Vers√≠culo: ${window.currentVerse}` }]
            })
        });

        const data = await response.json();
        studyArea.classList.remove('hidden');
        content.innerText = data.choices[0].message.content;
        btn.innerText = "ESTUDO PRONTO!";
    } catch (e) {
        alert("Erro na IA. Verifique sua chave.");
        btn.disabled = false;
        btn.innerText = "TENTAR NOVAMENTE";
    }
  };

  // FUN√á√ÉO DE FINALIZAR (SOMA XP)
  window.finishTask = async () => {
    const user = auth.currentUser;
    if (!user) return;

    const btn = document.getElementById('btn-finish');
    btn.innerText = "SALVANDO...";
    btn.disabled = true;

    try {
        const userRef = doc(db, "users", user.uid);
        await updateDoc(userRef, {
            xp: increment(10)
        });
        
        // Atualiza na tela
        const currentXP = parseInt(document.getElementById('xp-val').innerText);
        document.getElementById('xp-val').innerText = currentXP + 10;
        
        alert("Excelente! Voc√™ ganhou 10 XP. Continue firme no estudo!");
        location.reload(); // Recarrega para o pr√≥ximo vers√≠culo
    } catch (e) {
        alert("Erro ao salvar progresso.");
        btn.disabled = false;
    }
  };
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BibliaQuest - Duarte & Maria Clara</title>
    <style>
        :root { --primary: #58cc02; --blue: #1cb0f6; --bg: #f7f7f7; --text: #4b4b4b; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); margin: 0; display: flex; justify-content: center; color: var(--text); }
        #app { width: 100%; max-width: 500px; background: white; min-height: 100vh; padding: 20px; box-sizing: border-box; box-shadow: 0 0 10px rgba(0,0,0,0.05); }
        .hidden { display: none; }
        h2 { color: var(--primary); text-align: center; }
        input { width: 100%; padding: 12px; margin: 10px 0; border: 2px solid #e5e5e5; border-radius: 12px; box-sizing: border-box; }
        button { width: 100%; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; margin-top: 10px; transition: filter 0.2s; }
        button:disabled { background: #ccc; }
        button:hover { filter: brightness(0.9); }
        .card { border: 2px solid #e5e5e5; border-radius: 15px; padding: 15px; margin: 20px 0; background: white; }
        .header-stats { display: flex; justify-content: space-between; align-items: center; font-weight: bold; padding-bottom: 15px; border-bottom: 2px solid #f1f1f1; }
        #verse-text { font-style: italic; font-size: 1.1rem; line-height: 1.5; margin: 10px 0; }
        #ai-study-content { white-space: pre-wrap; line-height: 1.6; font-size: 0.95rem; }
    </style>
</head>
<body>

<div id="app">
    <div id="auth-screen">
        <h2>BibliaQuest</h2>
        <p style="text-align:center">Seu estudo b√≠blico gamificado</p>
        <input type="email" id="login-email" placeholder="E-mail">
        <input type="password" id="login-pass" placeholder="Senha">
        <button onclick="handleAuth('login')">Entrar</button>
        <button style="background: var(--blue)" onclick="handleAuth('signup')">Criar minha conta</button>
    </div>

    <div id="main-screen" class="hidden">
        <div class="header-stats">
            <span id="user-display">Duarte</span>
            <span>üî• <b id="streak-val">0</b> | XP: <b id="xp-val">0</b></span>
        </div>
        
        <div class="card">
            <h3 style="margin-top:0">üìñ Palavra do Dia</h3>
            <p id="verse-text">Buscando vers√≠culo em portugu√™s...</p>
            <small id="verse-ref" style="color: var(--blue); font-weight:bold"></small>
        </div>

        <button id="btn-study" onclick="generateStudy()">Gerar Estudo com IA</button>

        <div id="study-area" class="hidden">
            <div class="card" id="ai-study-content" style="background: #f0f9ff; border-color: var(--blue);">
                </div>
            <div id="quiz-area"></div>
        </div>
        
        <button style="background: #ff4b4b; margin-top: 40px; font-size: 0.8rem; padding: 10px;" onclick="auth.signOut()">Sair da conta</button>
    </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  // 1. CONFIGURA√á√ÉO FIREBASE (SUAS CHAVES REVALIDADAS)
  const firebaseConfig = {
    apiKey: "AIzaSyCAqU2eK-r5BBSud1nSZJHSbykATXdQNS4",
    authDomain: "bibliaquest-fbc44.firebaseapp.com",
    projectId: "bibliaquest-fbc44",
    storageBucket: "bibliaquest-fbc44.firebasestorage.app",
    messagingSenderId: "670585434397",
    appId: "1:670585434397:web:6d699582986e8dcbc6f1f4",
    measurementId: "G-H0Z7T8LCPE"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

 // 2. CONFIGURA√á√ÉO GROQ (SEGURA PARA GITHUB)
let GROQ_API_KEY = localStorage.getItem("groq_key");

if (!GROQ_API_KEY) {
    GROQ_API_KEY = prompt("Para usar o BibliaQuest, insira sua chave API do Groq (isso s√≥ ser√° pedido uma vez):");
    if (GROQ_API_KEY) {
        localStorage.setItem("groq_key", GROQ_API_KEY);
    }
}

  // 3. L√ìGICA DE AUTENTICA√á√ÉO
  window.handleAuth = async (type) => {
    const email = document.getElementById('login-email').value;
    const pass = document.getElementById('login-pass').value;
    if(!email || !pass) return alert("Preencha todos os campos");

    try {
        if (type === 'signup') {
            const res = await createUserWithEmailAndPassword(auth, email, pass);
            await setDoc(doc(db, "users", res.user.uid), { xp: 0, streak: 1, name: email.split('@')[0] });
        } else {
            await signInWithEmailAndPassword(auth, email, pass);
        }
    } catch (e) { alert("Erro na autentica√ß√£o: " + e.message); }
  };

  // 4. MONITORAMENTO DE LOGIN
  onAuthStateChanged(auth, async (user) => {
    if (user) {
        document.getElementById('auth-screen').classList.add('hidden');
        document.getElementById('main-screen').classList.remove('hidden');
        document.getElementById('user-display').innerText = user.email.split('@')[0];
        loadUserData(user.uid);
        fetchVerse();
    } else {
        document.getElementById('auth-screen').classList.remove('hidden');
        document.getElementById('main-screen').classList.add('hidden');
    }
  });

  async function loadUserData(uid) {
    const snap = await getDoc(doc(db, "users", uid));
    if (snap.exists()) {
        document.getElementById('xp-val').innerText = snap.data().xp;
        document.getElementById('streak-val').innerText = snap.data().streak;
    }
  }

  // 5. BUSCA VERS√çCULO (ALMEIDA - PORTUGU√äS)
  async function fetchVerse() {
    try {
        const res = await fetch('https://bible-api.com/random?translation=almeida');
        const data = await res.json();
        document.getElementById('verse-text').innerText = `"${data.text.trim()}"`;
        document.getElementById('verse-ref').innerText = data.reference;
        window.currentVerse = data.text; 
    } catch (e) {
        document.getElementById('verse-text').innerText = "Erro ao buscar a Palavra. Verifique sua conex√£o.";
    }
  }

  // 6. GERAR ESTUDO COM IA (GROQ)
  window.generateStudy = async () => {
    const btn = document.getElementById('btn-study');
    const studyContent = document.getElementById('ai-study-content');
    
    if (!window.currentVerse) return alert("Aguarde o carregamento do vers√≠culo.");

    btn.innerText = "IA preparando seu estudo...";
    btn.disabled = true;

    try {
        const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
            method: "POST",
            headers: {
                "Authorization": `Bearer ${GROQ_API_KEY}`,
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                model: "llama-3.3-70b-versatile",
                messages: [
                    {
                        role: "system",
                        content: "Voc√™ √© um tutor b√≠blico. Responda ESTRITAMENTE em Portugu√™s (PT-BR). Gere um estudo curto de 2 par√°grafos e uma pergunta de m√∫ltipla escolha com 3 op√ß√µes (A, B, C)."
                    },
                    {
                        role: "user",
                        content: `Estude este vers√≠culo: "${window.currentVerse}"`
                    }
                ]
            })
        });

        const data = await response.json();
        if (data.choices && data.choices[0].message) {
            document.getElementById('study-area').classList.remove('hidden');
            studyContent.innerText = data.choices[0].message.content;
            btn.innerText = "Estudo Gerado com Sucesso!";
        }
    } catch (e) {
        alert("Erro ao conectar com a IA. Tente novamente.");
        btn.disabled = false;
        btn.innerText = "Tentar Novamente";
    }
  };
</script>
</body>
</html>
